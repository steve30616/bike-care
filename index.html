<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ©Ÿè»Šä¿é¤Šç®¡å®¶ Elite</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background-color: #f4f6f9; font-family: -apple-system, sans-serif; padding-bottom: 100px; }
        .container { max-width: 500px; }
        #loader { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.9); display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 9999; }
        .spinner { width: 40px; height: 40px; border: 4px solid #f3f3f3; border-top: 4px solid #0d6efd; border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        /* å¡ç‰‡æ¨£å¼ */
        .card-item { border-radius: 20px; border: 2px solid transparent; box-shadow: 0 4px 12px rgba(0,0,0,0.05); margin-bottom: 15px; cursor: pointer; background: white; padding: 20px; transition: 0.3s; }
        
        /* éæœŸæ™‚çš„æ•´æ ¼è®Šç´… */
        .card-expired { background-color: #fff5f5; border-color: #feb2b2; }
        .card-expired .progress { background-color: #fed7d7; }
        
        .status-danger { color: #dc3545 !important; } 
        .status-ok { color: #198754 !important; }
        .progress { height: 8px; border-radius: 10px; background-color: #eee; }
        
        .btn-fab { position: fixed; bottom: 25px; left: 50%; transform: translateX(-50%); width: 90%; max-width: 400px; border-radius: 30px; padding: 15px; font-weight: bold; box-shadow: 0 4px 15px rgba(13, 110, 253, 0.3); z-index: 100; }
        .mode-btn { border-radius: 12px; border: 2px solid #f0f0f0; padding: 12px; cursor: pointer; transition: 0.2s; background: white; text-align: center; }
        .mode-btn.active { border-color: #0d6efd; background-color: #f0f7ff; color: #0d6efd; font-weight: bold; }
        .item-label-danger { color: #dc3545; font-weight: bold; }
        .item-label-success { color: #198754; }
        .category-header { font-size: 0.9rem; font-weight: bold; color: #6c757d; margin: 25px 0 10px 5px; }
        .warning-text { color: #dc3545; font-size: 0.9rem; margin-left: 8px; }
    </style>
</head>
<body>

<div id="loader"><div class="spinner"></div><div class="mt-2 text-primary fw-bold">åŒæ­¥ä¸­...</div></div>

<div id="app" class="container py-4">
    <div id="setup-view" style="display:none;">
        <h2 class="fw-bold text-center mb-4">ğŸš² å»ºç«‹æ©Ÿè»Šæª”æ¡ˆ</h2>
        <div class="card p-4 shadow-sm border-0">
            <input type="text" id="new-v-name" class="form-control mb-3" placeholder="æ©Ÿè»Šåç¨±">
            <input type="number" id="new-v-odo" class="form-control mb-4" placeholder="ç¸½é‡Œç¨‹ (km)">
            <button onclick="createNewVehicle()" class="btn btn-primary w-100 py-3 fw-bold">é–‹å§‹ç´€éŒ„</button>
        </div>
    </div>

    <div id="main-view" style="display:none;">
        <div class="d-flex justify-content-between align-items-end mb-4 px-2">
            <div>
                <h2 class="fw-bold mb-0 text-primary">
                    <span id="display-name">---</span><span id="name-warning" class="warning-text" style="display:none;">âš ï¸ éœ€ä¿é¤Š</span>
                </h2>
                <small class="text-muted">é»æ“Šå¡ç‰‡èª¿æ•´æé†’æ–¹å¼</small>
            </div>
            <div class="text-end"><span class="badge bg-dark fs-6" id="display-odo">--- km</span></div>
        </div>
        <button onclick="toggleOdoInput()" class="btn btn-white bg-white w-100 mb-3 shadow-sm py-2" style="border-radius:12px;">ğŸ“ æ›´æ–°ç›®å‰ç¸½é‡Œç¨‹</button>
        <div id="update-odo-section" style="display:none;" class="card p-3 mb-4 border-0 shadow-sm">
            <div class="row g-2">
                <div class="col-6"><input type="number" id="new-odo-input" class="form-control" placeholder="é‡Œç¨‹"></div>
                <div class="col-6"><input type="date" id="new-odo-date" class="form-control"></div>
                <div class="col-12 mt-2"><button onclick="submitOdo()" class="btn btn-dark w-100">æ›´æ–°</button></div>
            </div>
        </div>
        <div id="items-container"></div>
    </div>
</div>

<button id="fab-btn" class="btn btn-primary btn-fab" onclick="openServiceModal()" style="display:none;">â• ç™»è¨˜ä¿é¤Šé …ç›®</button>

<div class="modal fade" id="serviceModal" tabindex="-1" aria-hidden="true"><div class="modal-dialog modal-dialog-centered"><div class="modal-content" style="border-radius:25px;">
    <div class="modal-header border-0 pb-0 px-4 pt-4"><h5 class="modal-title fw-bold">ä¿é¤Šç™»è¨˜</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
    <div class="modal-body px-4">
        <div id="multi-select-list" class="mb-3 p-2 bg-light rounded" style="max-height:350px; overflow-y:auto;"></div>
        <div class="row g-2 mb-3">
            <div class="col-6"><label class="small fw-bold">æ—¥æœŸ</label><input type="date" id="sDate" class="form-control"></div>
            <div class="col-6"><label class="small fw-bold">é‡Œç¨‹</label><input type="number" id="sOdo" class="form-control"></div>
        </div>
        <button onclick="submitMultiService()" class="btn btn-primary w-100 py-3 fw-bold mb-3 shadow-sm">ç¢ºèªå®Œæˆç™»è¨˜</button>
    </div>
</div></div></div>

<div class="modal fade" id="intervalModal" tabindex="-1" aria-hidden="true"><div class="modal-dialog modal-dialog-centered"><div class="modal-content" style="border-radius:25px;">
    <div class="modal-body p-4 text-center">
        <h5 id="intItemName" class="fw-bold mb-4">èª¿æ•´æé†’é€±æœŸ</h5>
        <div class="row g-2 mb-4">
            <div class="col-6"><div id="mode-km" class="mode-btn" onclick="setMode('KM')">æ–¹å¼ä¸€<br><small>æŒ‰é‡Œç¨‹æé†’</small></div></div>
            <div class="col-6"><div id="mode-mon" class="mode-btn" onclick="setMode('MON')">æ–¹å¼äºŒ<br><small>æŒ‰æ—¥æœŸæé†’</small></div></div>
        </div>
        <div id="input-km-area" class="mb-3" style="display:none;">
            <label class="small fw-bold text-primary">é‡Œç¨‹é–“éš” (km)</label>
            <input type="number" id="newIntKm" class="form-control form-control-lg mb-1">
            <div id="hintKm" class="small text-muted"></div>
        </div>
        <div id="input-mon-area" class="mb-4" style="display:none;">
            <label class="small fw-bold text-primary">æ™‚é–“é–“éš” (æœˆ)</label>
            <input type="number" id="newIntMon" class="form-control form-control-lg mb-1">
            <div id="hintMon" class="small text-muted"></div>
        </div>
        <button onclick="submitNewInterval()" class="btn btn-dark w-100 py-3 fw-bold" style="border-radius:15px;">å„²å­˜ä¸¦åˆ‡æ›</button>
    </div>
</div></div></div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    const API_URL = "https://script.google.com/macros/s/AKfycbxNLVPzELXmUeXSmHIoxrKMxsrbtXD7VEWbNMBpahecHjgwm6VHxxNmZlVPb-Ny4EwhIQ/exec"; 
    let currentOwnerId = new URLSearchParams(window.location.search).get('id');
    let allItems = [], itemToEdit = "", selectedMode = "KM";

    window.onload = () => { if (!currentOwnerId) { hideLoader(); document.getElementById('setup-view').style.display='block'; } else { document.getElementById('fab-btn').style.display='block'; loadVehicleData(); } };
    function showLoader() { document.getElementById('loader').style.display='flex'; }
    function hideLoader() { document.getElementById('loader').style.display='none'; }

    async function loadVehicleData() {
        showLoader();
        try {
            const res = await fetch(`${API_URL}?ownerId=${currentOwnerId}`);
            const data = await res.json();
            allItems = data.items;
            document.getElementById('display-name').innerText = data.vehicleName;
            document.getElementById('display-odo').innerText = data.currentOdo + " km";
            
            // æª¢æŸ¥æ˜¯å¦æœ‰ä»»ä½•é …ç›®éœ€è¦ä¿é¤Š
            const needsMaintenance = allItems.some(item => item.status === "Expired");
            document.getElementById('name-warning').style.display = needsMaintenance ? "inline" : "none";

            const container = document.getElementById('items-container');
            container.innerHTML = "";
            ["è€—ææ›´æ›é¡", "ç³»çµ±æª¢æ¸¬é¡"].forEach(cat => {
                const items = data.items.filter(i => i.category === cat);
                if (items.length > 0) {
                    container.innerHTML += `<div class="category-header text-uppercase letter-spacing-1">${cat}</div>`;
                    items.forEach(item => {
                        const isExpired = item.status === "Expired";
                        const cardClass = isExpired ? "card-item card-expired" : "card-item";
                        const statusClass = isExpired ? "status-danger" : "status-ok";
                        
                        container.innerHTML += `
                            <div class="${cardClass}" onclick="openIntervalModal('${item.name}',${item.intKm},${item.intMon},${item.offKm},${item.offMon},'${item.mode}')">
                                <div class="d-flex justify-content-between mb-2">
                                    <div class="fw-bold fs-5">${item.name}</div>
                                    <div class="${statusClass} fw-bold">å‰© ${item.displayValue}</div>
                                </div>
                                <div class="progress"><div class="progress-bar ${isExpired ?'bg-danger':'bg-success'}" style="width:${item.progress}%"></div></div>
                            </div>`;
                    });
                }
            });
            document.getElementById('main-view').style.display='block';
        } catch (e) { alert("è®€å–å¤±æ•—"); }
        hideLoader();
    }

    function setMode(m) {
        selectedMode = m;
        document.getElementById('mode-km').classList.toggle('active', m === 'KM');
        document.getElementById('mode-mon').classList.toggle('active', m === 'MON');
        document.getElementById('input-km-area').style.display = (m === 'KM') ? 'block' : 'none';
        document.getElementById('input-mon-area').style.display = (m === 'MON') ? 'block' : 'none';
    }

    function openIntervalModal(name, k, m, ok, om, mode) {
        itemToEdit = name; document.getElementById('intItemName').innerText = name;
        document.getElementById('newIntKm').value = k; document.getElementById('newIntMon').value = m;
        document.getElementById('hintKm').innerText = `ğŸ’¡ å®˜æ–¹å»ºè­°ï¼š${ok} km`; 
        document.getElementById('hintMon').innerText = `ğŸ’¡ å®˜æ–¹å»ºè­°ï¼š${om} å€‹æœˆ`;
        setMode(mode || "KM");
        new bootstrap.Modal(document.getElementById('intervalModal')).show();
    }

    async function submitNewInterval() {
        showLoader();
        await fetch(API_URL, {method:"POST", body:JSON.stringify({action:"updateInterval", ownerId:currentOwnerId, itemName:itemToEdit, newKm:parseInt(document.getElementById('newIntKm').value), newMon:parseInt(document.getElementById('newIntMon').value), mode:selectedMode})});
        location.reload();
    }

    function openServiceModal() {
        const list = document.getElementById('multi-select-list'); list.innerHTML = "";
        allItems.forEach(i => {
            const isDanger = i.status === "Expired";
            const labelClass = isDanger ? "item-label-danger" : "item-label-success";
            list.innerHTML += `
                <div class="form-check py-3 border-bottom d-flex align-items-center">
                    <input class="form-check-input ms-0 me-3" type="checkbox" value="${i.name}" id="c-${i.name}" style="width:22px; height:22px; flex-shrink:0;">
                    <label class="form-check-label d-block ${labelClass} w-100" for="c-${i.name}">
                        ${i.name} <span class="text-muted fw-normal small ms-2">(å‰© ${i.displayValue})</span>
                    </label>
                </div>`;
        });
        document.getElementById('sDate').value = new Date().toISOString().split('T')[0];
        document.getElementById('sOdo').value = document.getElementById('display-odo').innerText.split(' ')[0];
        new bootstrap.Modal(document.getElementById('serviceModal')).show();
    }

    async function submitMultiService() {
        const names = Array.from(document.querySelectorAll('#multi-select-list input:checked')).map(cb => cb.value);
        if(names.length === 0) return alert("è«‹è‡³å°‘å‹¾é¸ä¸€å€‹ä¿é¤Šé …ç›®");
        showLoader();
        await fetch(API_URL, {method:"POST", body:JSON.stringify({action:"logService", ownerId:currentOwnerId, itemNames:names, date:document.getElementById('sDate').value, odo:parseInt(document.getElementById('sOdo').value)})});
        location.reload();
    }

    async function createNewVehicle() {
        const name = document.getElementById('new-v-name').value, odo = document.getElementById('new-v-odo').value;
        if(!name || !odo) return;
        showLoader();
        const id = 'BIKE-' + Math.random().toString(36).substr(2,6).toUpperCase();
        await fetch(API_URL, {method:"POST", body:JSON.stringify({action:"createVehicle", ownerId:id, name:name, odo:parseInt(odo)})});
        window.location.search = `?id=${id}`;
    }

    function toggleOdoInput() { 
        const el = document.getElementById('update-odo-section'); 
        el.style.display = el.style.display==='none'?'block':'none';
        document.getElementById('new-odo-date').value = new Date().toISOString().split('T')[0];
    }

    async function submitOdo() {
        const odo = document.getElementById('new-odo-input').value;
        if(!odo) return;
        showLoader();
        await fetch(API_URL, {method:"POST", body:JSON.stringify({action:"updateOdo", ownerId:currentOwnerId, odo:parseInt(odo), date:document.getElementById('new-odo-date').value})});
        location.reload();
    }
</script>
</body>
</html>
