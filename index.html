<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ©Ÿè»Šä¿é¤Šå°å¹«æ‰‹</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background-color: #f4f7f6; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; }
        .container { max-width: 500px; }
        .card { border-radius: 15px; border: none; box-shadow: 0 4px 12px rgba(0,0,0,0.05); margin-bottom: 12px; transition: transform 0.2s; }
        .card:active { transform: scale(0.98); }
        .progress { height: 8px; border-radius: 10px; background-color: #e9ecef; }
        .category-header { font-size: 0.85rem; font-weight: bold; color: #6c757d; margin: 20px 0 10px 5px; text-transform: uppercase; letter-spacing: 1px; }
        .odo-badge { background: #212529; color: #fff; padding: 5px 12px; border-radius: 20px; font-weight: 600; }
        .status-ok { color: #198754; background: #e8f5e9; }
        .status-warn { color: #fd7e14; background: #fff3e0; }
        .status-danger { color: #dc3545; background: #ffebee; animation: pulse 2s infinite; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.6; } 100% { opacity: 1; } }
        .btn-main { border-radius: 12px; padding: 12px; font-weight: 600; }
    </style>
</head>
<body>

<div id="app" class="container py-4">
    <div id="setup-view" style="display:none;">
        <div class="text-center mb-4">
            <h2 class="fw-bold">ğŸš² æ©Ÿè»Šä¿é¤Šç´€éŒ„</h2>
            <p class="text-muted">å…ç™»å…¥ï¼Œå°ˆå±¬ç¶²å€è·Ÿè‘—ä½ </p>
        </div>
        <div class="card p-4">
            <div class="mb-3">
                <label class="form-label">æ©Ÿè»Šåç¨±</label>
                <input type="text" id="new-vehicle-name" class="form-control form-control-lg" placeholder="ä¾‹å¦‚ï¼šå‹æˆ°å…­ä»£">
            </div>
            <div class="mb-3">
                <label class="form-label">ç›®å‰ç¸½é‡Œç¨‹ (km)</label>
                <input type="number" id="new-vehicle-odo" class="form-control form-control-lg" placeholder="ä¾‹å¦‚ï¼š5000">
            </div>
            <button onclick="createNewVehicle()" class="btn btn-primary w-100 btn-main">é–‹å§‹ä½¿ç”¨</button>
        </div>
    </div>

    <div id="main-view" style="display:none;">
        <div class="d-flex justify-content-between align-items-end mb-3 px-2">
            <div>
                <h2 id="display-vehicle-name" class="fw-bold mb-0">è¼‰å…¥ä¸­...</h2>
                <small class="text-muted">é»æ“Šé …ç›®å¯ç™»è¨˜ä¿é¤Š</small>
            </div>
            <div class="odo-badge" id="display-odo">--- km</div>
        </div>

        <button onclick="toggleOdoInput()" class="btn btn-outline-dark w-100 mb-4 btn-main">ğŸ“ æ›´æ–°ç›®å‰é‡Œç¨‹</button>

        <div id="update-odo-section" style="display:none;" class="card p-3 mb-4 bg-light">
            <div class="input-group">
                <input type="number" id="new-odo-input" class="form-control" placeholder="è¼¸å…¥æœ€æ–°ç¸½é‡Œç¨‹">
                <button onclick="submitOdo()" class="btn btn-dark">æ›´æ–°</button>
            </div>
        </div>

        <div id="items-container">
            </div>
    </div>
</div>

<div class="modal fade" id="serviceModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content" style="border-radius: 20px;">
            <div class="modal-header border-0 pb-0">
                <h5 class="modal-title fw-bold" id="modalItemName">ç™»è¨˜ä¿é¤Š</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label class="form-label small text-muted">ä¿é¤Šæ—¥æœŸ</label>
                    <input type="date" id="serviceDate" class="form-control form-control-lg">
                </div>
                <div class="mb-3">
                    <label class="form-label small text-muted">æœ¬æ¬¡é‡Œç¨‹ (km)</label>
                    <input type="number" id="serviceOdo" class="form-control form-control-lg">
                </div>
                <button onclick="submitService()" class="btn btn-primary w-100 btn-main mt-2">ç¢ºèªå®Œæˆ</button>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    // âš ï¸ é€™è£¡è«‹å¡«å…¥ä½ çš„ GAS ç¶²å€
    const API_URL = "https://script.google.com/macros/s/AKfycbxNLVPzELXmUeXSmHIoxrKMxsrbtXD7VEWbNMBpahecHjgwm6VHxxNmZlVPb-Ny4EwhIQ/exec"; 

    let currentOwnerId = new URLSearchParams(window.location.search).get('id');
    let selectedItem = "";

    window.onload = function() {
        if (!currentOwnerId) {
            document.getElementById('setup-view').style.display = 'block';
        } else {
            loadVehicleData();
        }
    };

    async function loadVehicleData() {
        document.getElementById('main-view').style.display = 'block';
        try {
            const res = await fetch(`${API_URL}?ownerId=${currentOwnerId}`);
            const data = await res.json();
            if (data.error) {
                alert("æ‰¾ä¸åˆ°è»Šè¼›ï¼Œè«‹é‡æ–°å»ºç«‹");
                location.search = "";
                return;
            }
            renderDashboard(data);
        } catch (e) { alert("é€£ç·šå¤±æ•—ï¼Œè«‹æª¢æŸ¥ API ç¶²å€"); }
    }

    function renderDashboard(data) {
        document.getElementById('display-vehicle-name').innerText = data.vehicleName;
        document.getElementById('display-odo').innerText = data.currentOdo + " km";
        const container = document.getElementById('items-container');
        container.innerHTML = "";

        const cats = ["è€—ææ›´æ›é¡", "ç³»çµ±æª¢æ¸¬é¡"];
        cats.forEach(cat => {
            const items = data.items.filter(i => i.category === cat);
            if (items.length > 0) {
                container.innerHTML += `<div class="category-header">${cat}</div>`;
                items.forEach(item => {
                    const statusClass = item.status === "Expired" ? "status-danger" : (item.status === "Warning" ? "status-warn" : "status-ok");
                    const progress = Math.max(5, Math.min(100, (item.remKm / item.intervalKm) * 100));
                    container.innerHTML += `
                        <div class="card p-3" onclick="openServiceModal('${item.name}')">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <span class="fw-bold">${item.name}</span>
                                <span class="badge ${statusClass}">${item.remKm} km å¾Œ</span>
                            </div>
                            <div class="progress"><div class="progress-bar ${item.status === 'Expired' ? 'bg-danger' : 'bg-primary'}" style="width: ${progress}%"></div></div>
                        </div>`;
                });
            }
        });
    }

    function toggleOdoInput() {
        const el = document.getElementById('update-odo-section');
        el.style.display = el.style.display === 'none' ? 'block' : 'none';
    }

    async function submitOdo() {
        const odo = document.getElementById('new-odo-input').value;
        if (!odo) return;
        await fetch(API_URL, { method: "POST", body: JSON.stringify({ action: "updateOdo", ownerId: currentOwnerId, odo: parseInt(odo) }) });
        location.reload();
    }

    function openServiceModal(name) {
        selectedItem = name;
        document.getElementById('modalItemName').innerText = name;
        document.getElementById('serviceDate').value = new Date().toISOString().split('T')[0];
        document.getElementById('serviceOdo').value = document.getElementById('display-odo').innerText.split(' ')[0];
        new bootstrap.Modal(document.getElementById('serviceModal')).show();
    }

    async function submitService() {
        const date = document.getElementById('serviceDate').value;
        const odo = document.getElementById('serviceOdo').value;
        await fetch(API_URL, { method: "POST", body: JSON.stringify({ action: "logService", ownerId: currentOwnerId, itemName: selectedItem, date: date, odo: parseInt(odo) }) });
        location.reload();
    }

    async function createNewVehicle() {
        const name = document.getElementById('new-vehicle-name').value;
        const odo = document.getElementById('new-vehicle-odo').value;
        if (!name || !odo) return alert("è«‹å¡«å¯«å®Œæ•´");
        const newId = 'BIKE-' + Math.random().toString(36).substr(2, 6).toUpperCase();
        await fetch(API_URL, { method: "POST", body: JSON.stringify({ action: "createVehicle", ownerId: newId, name: name, odo: parseInt(odo), model: "DEFAULT" }) });
        location.search = `?id=${newId}`;
    }
</script>
</body>
</html>
