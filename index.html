<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ê©üËªä‰øùÈ§äÂ∞èÂπ´Êâã</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background-color: #f4f7f6; font-family: -apple-system, sans-serif; }
        .container { max-width: 500px; }
        #loader { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.9); display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 9999; }
        .spinner { width: 40px; height: 40px; border: 4px solid #f3f3f3; border-top: 4px solid #0d6efd; border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .card { border-radius: 15px; border: none; box-shadow: 0 4px 12px rgba(0,0,0,0.05); margin-bottom: 12px; }
        .category-header { font-size: 0.85rem; font-weight: bold; color: #6c757d; margin: 20px 0 10px 5px; border-left: 4px solid #0d6efd; padding-left: 10px; }
        .status-danger { color: #dc3545; background: #ffebee; animation: pulse 2s infinite; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.7; } 100% { opacity: 1; } }
        .btn-main { border-radius: 12px; padding: 12px; font-weight: 600; }
    </style>
</head>
<body>

<div id="loader"><div class="spinner"></div><div class="mt-2 text-primary">ËÆÄÂèñ‰∏≠...</div></div>

<div id="app" class="container py-4">
    <div id="setup-view" style="display:none;">
        <h2 class="fw-bold text-center mb-4">üö≤ Ê©üËªä‰øùÈ§äÁ¥ÄÈåÑ</h2>
        <div class="card p-4">
            <input type="text" id="new-v-name" class="form-control mb-3" placeholder="Ê©üËªäÂêçÁ®±">
            <input type="number" id="new-v-odo" class="form-control mb-3" placeholder="ÁõÆÂâçÁ∏ΩÈáåÁ®ã">
            <button onclick="createNewVehicle()" class="btn btn-primary w-100 btn-main">ÈñãÂßã‰ΩøÁî®</button>
        </div>
    </div>

    <div id="main-view" style="display:none;">
        <div class="d-flex justify-content-between align-items-center mb-3 px-2">
            <h2 id="display-name" class="fw-bold mb-0">---</h2>
            <span class="badge bg-dark p-2" id="display-odo">--- km</span>
        </div>
        <button onclick="toggleOdoInput()" class="btn btn-outline-primary w-100 mb-4 btn-main">üìç Êõ¥Êñ∞ÈáåÁ®ã</button>
        <div id="update-odo-section" style="display:none;" class="card p-3 mb-4 bg-light">
            <div class="input-group">
                <input type="number" id="new-odo-input" class="form-control" placeholder="ÊúÄÊñ∞Á∏ΩÈáåÁ®ã">
                <button onclick="submitOdo()" class="btn btn-dark">Êõ¥Êñ∞</button>
            </div>
        </div>
        <div id="items-container"></div>
    </div>
</div>

<div class="modal fade" id="serviceModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered"><div class="modal-content" style="border-radius: 20px;">
        <div class="modal-header border-0 pb-0"><h5 class="modal-title fw-bold" id="modalItemName">ÁôªË®ò‰øùÈ§ä</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
        <div class="modal-body">
            <label class="form-label small">Êó•Êúü</label><input type="date" id="sDate" class="form-control mb-3">
            <label class="form-label small">‰øùÈ§äÊôÇÈáåÁ®ã</label><input type="number" id="sOdo" class="form-control mb-3">
            <button onclick="submitService()" class="btn btn-primary w-100 btn-main">Á¢∫Ë™çÂÆåÊàê</button>
        </div>
    </div></div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    const API_URL = "‰Ω†ÁöÑ_GAS_Á∂≤È†ÅÊáâÁî®Á®ãÂºèÁ∂≤ÂùÄ"; 
    let currentOwnerId = new URLSearchParams(window.location.search).get('id');
    let selectedItem = "";

    window.onload = () => { if (!currentOwnerId) { hideLoader(); document.getElementById('setup-view').style.display='block'; } else { loadVehicleData(); } };

    function showLoader() { document.getElementById('loader').style.display='flex'; }
    function hideLoader() { document.getElementById('loader').style.display='none'; }

    async function loadVehicleData() {
        showLoader();
        try {
            const res = await fetch(`${API_URL}?ownerId=${currentOwnerId}`);
            const data = await res.json();
            document.getElementById('display-name').innerText = data.vehicleName;
            document.getElementById('display-odo').innerText = data.currentOdo + " km";
            const container = document.getElementById('items-container');
            container.innerHTML = "";
            ["ËÄóÊùêÊõ¥ÊèõÈ°û", "Á≥ªÁµ±Ê™¢Ê∏¨È°û"].forEach(cat => {
                const items = data.items.filter(i => i.category === cat);
                if (items.length > 0) {
                    container.innerHTML += `<div class="category-header">${cat}</div>`;
                    items.forEach(item => {
                        const statusClass = item.status === "Expired" ? "status-danger" : (item.status === "Warning" ? "text-warning" : "text-success");
                        const progress = Math.max(5, Math.min(100, (item.remKm / item.intervalKm) * 100));
                        container.innerHTML += `<div class="card p-3" onclick="openModal('${item.name}')">
                            <div class="d-flex justify-content-between mb-2"><b>${item.name}</b><span class="badge ${statusClass}">${item.remKm} km Âæå</span></div>
                            <div class="progress"><div class="progress-bar ${item.status==='Expired'?'bg-danger':'bg-primary'}" style="width:${progress}%"></div></div>
                        </div>`;
                    });
                }
            });
            document.getElementById('main-view').style.display='block';
        } catch (e) { alert("ÈÄ£Á∑öÂ§±Êïó"); }
        hideLoader();
    }

    async function createNewVehicle() {
        const name = document.getElementById('new-v-name').value;
        const odo = document.getElementById('new-v-odo').value;
        if(!name || !odo) return;
        showLoader();
        const id = 'BIKE-' + Math.random().toString(36).substr(2,6).toUpperCase();
        await fetch(API_URL, {method:"POST", body:JSON.stringify({action:"createVehicle", ownerId:id, name, odo:parseInt(odo), model:"DEFAULT"})});
        window.location.search = `?id=${id}`;
    }

    function toggleOdoInput() { const el = document.getElementById('update-odo-section'); el.style.display = el.style.display==='none'?'block':'none'; }
    async function submitOdo() {
        const odo = document.getElementById('new-odo-input').value;
        showLoader();
        await fetch(API_URL, {method:"POST", body:JSON.stringify({action:"updateOdo", ownerId:currentOwnerId, odo:parseInt(odo)})});
        location.reload();
    }

    function openModal(name) {
        selectedItem = name;
        document.getElementById('modalItemName').innerText = name;
        document.getElementById('sDate').value = new Date().toISOString().split('T')[0];
        document.getElementById('sOdo').value = document.getElementById('display-odo').innerText.split(' ')[0];
        new bootstrap.Modal(document.getElementById('serviceModal')).show();
    }

    async function submitService() {
        showLoader();
        await fetch(API_URL, {method:"POST", body:JSON.stringify({action:"logService", ownerId:currentOwnerId, itemName:selectedItem, date:document.getElementById('sDate').value, odo:parseInt(document.getElementById('sOdo').value)})});
        location.reload();
    }
</script>
</body>
</html>
