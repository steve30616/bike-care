<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>機車保養管家 Elite</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background-color: #f8fafc; font-family: -apple-system, sans-serif; padding-bottom: 120px; }
        .container { max-width: 500px; }
        #loader { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.9); display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 9999; }
        .spinner { width: 40px; height: 40px; border: 4px solid #f3f3f3; border-top: 4px solid #0d6efd; border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .header-box { padding: 25px 0; border-radius: 0 0 30px 30px; background: white; margin-bottom: 25px; box-shadow: 0 2px 15px rgba(0,0,0,0.04); }
        .header-warning { background-color: #e11d48 !important; color: white !important; }
        .card-item { border-radius: 18px; border: none; border-left: 8px solid #10b981; box-shadow: 0 4px 12px rgba(0,0,0,0.04); margin-bottom: 12px; cursor: pointer; background: white; padding: 18px; }
        .card-expired { background-color: #fff1f2; border-left-color: #e11d48; }
        .progress { height: 8px; border-radius: 10px; background-color: #f1f5f9; }
        .btn-fab { position: fixed; bottom: 25px; left: 50%; transform: translateX(-50%); width: 92%; max-width: 420px; border-radius: 35px; padding: 18px; font-weight: 800; border: none; box-shadow: 0 10px 25px rgba(0,0,0,0.1); z-index: 100; }
        .btn-fab-warning { background-color: #e11d48 !important; animation: pulse-red 2s infinite; }
        @keyframes pulse-red { 0% { transform: translateX(-50%) scale(1); box-shadow: 0 0 0 0 rgba(225,29,72,0.7); } 70% { transform: translateX(-50%) scale(1.05); box-shadow: 0 0 0 15px rgba(225,29,72,0); } 100% { transform: translateX(-50%) scale(1); } }
        .category-header { font-size: 0.85rem; font-weight: 800; color: #94a3b8; margin: 30px 0 10px 5px; border-bottom: 1px solid #e2e8f0; }
    </style>
</head>
<body>

<div id="loader"><div class="spinner"></div><div class="mt-2 text-primary fw-bold">同步連線中...</div></div>

<div id="app">
    <div id="setup-view" class="container py-5" style="display:none;">
        <h2 class="fw-bold text-center mb-4 text-primary">建立車輛檔案</h2>
        <div class="card p-4 shadow-sm border-0" style="border-radius:25px;">
            <div class="mb-3">
                <label class="form-label fw-bold">機車名稱</label>
                <input type="text" id="new-v-name" class="form-control mb-2" placeholder="例如：我的勁戰">
            </div>
            <div class="mb-4">
                <label class="form-label fw-bold">目前總里程 (km)</label>
                <input type="number" id="new-v-odo" class="form-control" placeholder="請輸入儀表里程數">
            </div>
            <button onclick="createNewVehicle()" class="btn btn-primary w-100 py-3 fw-bold">開啟紀錄並建立車庫</button>
        </div>
    </div>

    <div id="main-view" style="display:none;">
        <div id="header-area" class="header-box">
            <div class="container d-flex justify-content-between align-items-center">
                <div class="text-start">
                    <h2 class="fw-bold mb-0" id="display-name">---</h2>
                    <small id="header-subtext">載入中...</small>
                </div>
                <span class="badge bg-dark fs-6" id="display-odo">--- km</span>
            </div>
        </div>
        <div class="container text-center">
            <div class="d-flex gap-2 mb-4">
                <button onclick="toggleOdoInput()" class="btn btn-white bg-white flex-grow-1 shadow-sm py-2 border-0 fw-bold">更新里程</button>
                <button onclick="openManageItemsModal()" class="btn btn-white bg-white shadow-sm py-2 border-0 fw-bold px-3">項目管理</button>
            </div>
            <div id="update-odo-section" style="display:none;" class="card p-3 mb-4 border-0 shadow-sm text-start">
                <div class="row g-2">
                    <div class="col-6"><input type="number" id="new-odo-input" class="form-control" placeholder="里程"></div>
                    <div class="col-6"><input type="date" id="new-odo-date" class="form-control"></div>
                    <div class="col-12 mt-2"><button onclick="submitOdo()" class="btn btn-dark w-100">更新</button></div>
                </div>
            </div>
            <div id="items-container"></div>
        </div>
    </div>
</div>

<button id="fab-btn" class="btn btn-primary btn-fab" onclick="openServiceModal()" style="display:none;">登記保養項目</button>

<div class="modal fade" id="manageItemsModal" tabindex="-1" aria-hidden="true"><div class="modal-dialog modal-dialog-centered"><div class="modal-content" style="border-radius:30px;"><div class="modal-header border-0 pb-0 px-4 pt-4"><h5 class="modal-title fw-bold">項目設定</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body px-4"><div id="all-items-list" class="mb-4 p-2 bg-light rounded" style="max-height:400px; overflow-y:auto;"></div><button onclick="submitManageItems()" class="btn btn-primary w-100 py-3 fw-bold">儲存變更</button></div></div></div></div>
<div class="modal fade" id="serviceModal" tabindex="-1" aria-hidden="true"><div class="modal-dialog modal-dialog-centered"><div class="modal-content" style="border-radius:30px;"><div class="modal-header border-0 pb-0 px-4 pt-4"><h5 class="modal-title fw-bold">保養登記</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body px-4"><div id="multi-select-list" class="mb-4 p-1 bg-light rounded" style="max-height:350px; overflow-y:auto;"></div><div class="row g-2 mb-4"><div class="col-6"><input type="date" id="sDate" class="form-control"></div><div class="col-6"><input type="number" id="sOdo" class="form-control"></div></div><button onclick="submitMultiService()" class="btn btn-primary w-100 py-3 fw-bold">登記完成</button></div></div></div></div>
<div class="modal fade" id="intervalModal" tabindex="-1" aria-hidden="true"><div class="modal-dialog modal-dialog-centered"><div class="modal-content" style="border-radius:30px;"><div class="modal-body p-4 text-center"><h5 id="intItemName" class="fw-bold mb-4">設定週期</h5><div class="d-flex gap-2 mb-4"><div id="mode-km" class="mode-btn" onclick="setMode('KM')">里程</div><div id="mode-mon" class="mode-btn" onclick="setMode('MON')">月份</div></div><div id="input-km-area" class="text-start mb-3"><input type="number" id="newIntKm" class="form-control"></div><div id="input-mon-area" class="text-start mb-4"><input type="number" id="newIntMon" class="form-control"></div><button onclick="submitNewInterval()" class="btn btn-dark w-100 py-3 fw-bold">儲存</button></div></div></div></div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    // ⚠️ 這裡填入你剛剛部署的新網址
    const API_URL = "https://script.google.com/macros/s/AKfycbxNLVPzELXmUeXSmHIoxrKMxsrbtXD7VEWbNMBpahecHjgwm6VHxxNmZlVPb-Ny4EwhIQ/exec"; 
    
    let currentOwnerId = new URLSearchParams(window.location.search).get('id');
    let allItems = [], itemToEdit = "", selectedMode = "KM";

    window.onload = () => { if (!currentOwnerId) { hideLoader(); document.getElementById('setup-view').style.display='block'; } else { document.getElementById('fab-btn').style.display='block'; loadVehicleData(); } };
    function showLoader() { document.getElementById('loader').style.display='flex'; }
    function hideLoader() { document.getElementById('loader').style.display='none'; }

    async function createNewVehicle() {
        const name = document.getElementById('new-v-name').value;
        const odo = document.getElementById('new-v-odo').value;
        if(!name || !odo) return alert("請輸入車名與里程");
        
        showLoader();
        const id = 'BIKE-' + Math.random().toString(36).substr(2,6).toUpperCase();
        try {
            const response = await fetch(API_URL, {
                method: "POST",
                mode: "no-cors", // 重要：GAS 的 POST 必須用 no-cors
                body: JSON.stringify({ action: "createVehicle", ownerId: id, name: name, odo: parseInt(odo) })
            });
            // 因為 no-cors 無法讀取回應，我們直接假設成功並跳轉
            setTimeout(() => { window.location.search = `?id=${id}`; }, 1500);
        } catch (e) {
            alert("建立失敗，請檢查網路");
            hideLoader();
        }
    }

    async function loadVehicleData() {
        showLoader();
        try {
            const res = await fetch(`${API_URL}?ownerId=${currentOwnerId}`);
            const data = await res.json();
            allItems = data.items;
            document.getElementById('display-name').innerText = data.vehicleName;
            document.getElementById('display-odo').innerText = data.currentOdo + " km";
            const activeItems = allItems.filter(i => i.isActive);
            const hasExpired = activeItems.some(item => item.status === "Expired");
            const header = document.getElementById('header-area');
            const fab = document.getElementById('fab-btn');
            header.className = hasExpired ? 'header-box header-warning' : 'header-box';
            document.getElementById('header-subtext').innerText = hasExpired ? "有項目已到保養期限" : "目前車況良好";
            fab.className = hasExpired ? 'btn btn-primary btn-fab btn-fab-warning' : 'btn btn-primary btn-fab';
            const container = document.getElementById('items-container');
            container.innerHTML = "";
            const categories = [...new Set(activeItems.map(i => i.category))];
            categories.forEach(cat => {
                const items = activeItems.filter(i => i.category === cat);
                container.innerHTML += `<div class="category-header">${cat}</div>`;
                items.forEach(item => {
                    container.innerHTML += `<div class="card-item ${item.status==='Expired'?'card-expired':''}" onclick="openIntervalModal('${item.name}',${item.intKm},${item.intMon},${item.offKm},${item.offMon},'${item.mode}')">
                        <div class="d-flex justify-content-between mb-2"><div class="fw-bold fs-5">${item.name}</div><div class="${item.status==='Expired'?'text-danger fw-bold':'text-success fw-bold'}">剩 ${item.displayValue}</div></div>
                        <div class="progress"><div class="progress-bar ${item.status==='Expired'?'bg-danger':'bg-success'}" style="width:${item.progress}%"></div></div></div>`;
                });
            });
            document.getElementById('main-view').style.display='block';
        } catch (e) { alert("讀取異常"); }
        hideLoader();
    }

    // 其它函數 (submitOdo, openManageItemsModal, submitManageItems, openServiceModal, submitMultiService, setMode, openIntervalModal, submitNewInterval, toggleOdoInput) 維持原本邏輯
    function toggleOdoInput() { const el = document.getElementById('update-odo-section'); el.style.display = el.style.display==='none'?'block':'none'; document.getElementById('new-odo-date').value = new Date().toISOString().split('T')[0]; }
    async function submitOdo() { const odo = document.getElementById('new-odo-input').value; if(!odo) return; showLoader(); await fetch(API_URL, {method:"POST", mode:"no-cors", body:JSON.stringify({action:"updateOdo", ownerId:currentOwnerId, odo:parseInt(odo), date:document.getElementById('new-odo-date').value})}); setTimeout(() => location.reload(), 1500); }
    function openManageItemsModal() { const list = document.getElementById('all-items-list'); list.innerHTML = ""; allItems.forEach(i => { list.innerHTML += `<div class="form-check py-3 border-bottom d-flex align-items-center"><input class="form-check-input ms-0 me-3" type="checkbox" value="${i.name}" id="m-${i.name}" ${i.isActive?'checked':''} style="width:24px; height:24px;"><label class="form-check-label d-block w-100 fw-bold" for="m-${i.name}">${i.name} <small class="text-muted">(${i.category})</small></label></div>`; }); new bootstrap.Modal(document.getElementById('manageItemsModal')).show(); }
    async function submitManageItems() { const activeItems = Array.from(document.querySelectorAll('#all-items-list input:checked')).map(cb => cb.value); showLoader(); await fetch(API_URL, {method:"POST", mode:"no-cors", body:JSON.stringify({action:"toggleItems", ownerId:currentOwnerId, activeItems:activeItems})}); setTimeout(() => location.reload(), 1500); }
    function openServiceModal() { const list = document.getElementById('multi-select-list'); list.innerHTML = ""; allItems.filter(i => i.isActive).forEach(i => { list.innerHTML += `<div class="form-check py-3 border-bottom d-flex align-items-center"><input class="form-check-input ms-0 me-3" type="checkbox" value="${i.name}" id="c-${i.name}" style="width:24px; height:24px;"><label class="form-check-label d-block w-100 ${i.status==='Expired'?'text-danger fw-bold':'text-success'}" for="c-${i.name}">${i.name} <small class="text-muted">(${i.displayValue})</small></label></div>`; }); document.getElementById('sDate').value = new Date().toISOString().split('T')[0]; document.getElementById('sOdo').value = document.getElementById('display-odo').innerText.split(' ')[0]; new bootstrap.Modal(document.getElementById('serviceModal')).show(); }
    async function submitMultiService() { const names = Array.from(document.querySelectorAll('#multi-select-list input:checked')).map(cb => cb.value); if(!names.length) return; showLoader(); await fetch(API_URL, {method:"POST", mode:"no-cors", body:JSON.stringify({action:"logService", ownerId:currentOwnerId, itemNames:names, date:document.getElementById('sDate').value, odo:parseInt(document.getElementById('sOdo').value)})}); setTimeout(() => location.reload(), 1500); }
    function setMode(m) { selectedMode = m; document.getElementById('mode-km').classList.toggle('active', m === 'KM'); document.getElementById('mode-mon').classList.toggle('active', m === 'MON'); document.getElementById('input-km-area').style.display = (m === 'KM') ? 'block' : 'none'; document.getElementById('input-mon-area').style.display = (m === 'MON') ? 'block' : 'none'; }
    function openIntervalModal(name, k, m, ok, om, mode) { itemToEdit = name; document.getElementById('intItemName').innerText = name; document.getElementById('newIntKm').value = k; document.getElementById('newIntMon').value = m; document.getElementById('hintKm').innerText = `建議：${ok} km`; document.getElementById('hintMon').innerText = `建議：${om} 月`; setMode(mode || "KM"); new bootstrap.Modal(document.getElementById('intervalModal')).show(); }
    async function submitNewInterval() { showLoader(); await fetch(API_URL, {method:"POST", mode:"no-cors", body:JSON.stringify({action:"updateInterval", ownerId:currentOwnerId, itemName:itemToEdit, newKm:parseInt(document.getElementById('newIntKm').value), newMon:parseInt(document.getElementById('newIntMon').value), mode:selectedMode})}); setTimeout(() => location.reload(), 1500); }
</script>
</body>
</html>
