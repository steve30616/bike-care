<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ©Ÿè»Šä¿é¤Šå°å¹«æ‰‹ Pro</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background-color: #f4f7f6; font-family: -apple-system, sans-serif; }
        .container { max-width: 500px; }
        #loader { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.9); display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 9999; }
        .spinner { width: 40px; height: 40px; border: 4px solid #f3f3f3; border-top: 4px solid #0d6efd; border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .card { border-radius: 15px; border: none; box-shadow: 0 4px 12px rgba(0,0,0,0.05); margin-bottom: 12px; }
        .category-header { font-size: 0.85rem; font-weight: bold; color: #6c757d; margin: 20px 0 10px 5px; border-left: 4px solid #0d6efd; padding-left: 10px; }
        .status-danger { color: #dc3545 !important; font-weight: bold; }
        .status-warn { color: #fd7e14 !important; font-weight: bold; }
        .status-ok { color: #198754 !important; font-weight: bold; }
        .progress { height: 12px; border-radius: 10px; cursor: pointer; }
        .btn-main { border-radius: 12px; padding: 12px; font-weight: 600; }
        .edit-icon { font-size: 0.8rem; cursor: pointer; color: #adb5bd; }
        .edit-icon:hover { color: #0d6efd; }
    </style>
</head>
<body>

<div id="loader"><div class="spinner"></div><div class="mt-2 text-primary">åŒæ­¥é›²ç«¯è³‡æ–™ä¸­...</div></div>

<div id="app" class="container py-4">
    <div id="setup-view" style="display:none;">
        <h2 class="fw-bold text-center mb-4">ğŸš² æ©Ÿè»Šä¿é¤Šç´€éŒ„</h2>
        <div class="card p-4 text-center">
            <p class="text-muted">ç¬¬ä¸€æ¬¡ä½¿ç”¨ï¼Ÿè«‹å…ˆè¨­å®šæ‚¨çš„æ„›è»Š</p>
            <input type="text" id="new-v-name" class="form-control mb-3" placeholder="æ©Ÿè»Šåç¨± (ä¾‹å¦‚ï¼šå‹æˆ°å…­ä»£)">
            <input type="number" id="new-v-odo" class="form-control mb-3" placeholder="ç›®å‰ç¸½é‡Œç¨‹ (Odometer)">
            <button onclick="createNewVehicle()" class="btn btn-primary w-100 btn-main">å»ºç«‹è»Šåº«ä¸¦é–‹å§‹</button>
        </div>
    </div>

    <div id="main-view" style="display:none;">
        <div class="d-flex justify-content-between align-items-center mb-3 px-2">
            <div>
                <h2 id="display-name" class="fw-bold mb-0">---</h2>
                <small class="text-muted">é»æ“Šé€²åº¦æ¢å¯ç™»è¨˜ä¿é¤Š</small>
            </div>
            <span class="badge bg-dark p-2 fs-6" id="display-odo">--- km</span>
        </div>

        <button onclick="toggleOdoInput()" class="btn btn-outline-primary w-100 mb-4 btn-main">ğŸ“ æ›´æ–°ç›®å‰é‡Œç¨‹</button>
        
        <div id="update-odo-section" style="display:none;" class="card p-3 mb-4 bg-light">
            <div class="input-group">
                <input type="number" id="new-odo-input" class="form-control" placeholder="è¼¸å…¥æœ€æ–°é‡Œç¨‹è¡¨æ•¸å€¼">
                <button onclick="submitOdo()" class="btn btn-dark">æ›´æ–°</button>
            </div>
        </div>

        <div id="items-container"></div>
    </div>
</div>

<div class="modal fade" id="serviceModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered"><div class="modal-content" style="border-radius: 20px;">
        <div class="modal-header border-0 pb-0"><h5 class="modal-title fw-bold">ç™»è¨˜ä¿é¤Šé …ç›®</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
        <div class="modal-body">
            <div id="multi-select-list" class="mb-3 p-2 bg-light rounded" style="max-height: 250px; overflow-y: auto;">
                </div>
            <div class="row g-2">
                <div class="col-6">
                    <label class="form-label small text-muted">ä¿é¤Šæ—¥æœŸ</label>
                    <input type="date" id="sDate" class="form-control">
                </div>
                <div class="col-6">
                    <label class="form-label small text-muted">ä¿é¤Šé‡Œç¨‹</label>
                    <input type="number" id="sOdo" class="form-control">
                </div>
            </div>
            <button onclick="submitMultiService()" class="btn btn-primary w-100 btn-main mt-4">ç¢ºèªå®Œæˆå·²é¸é …ç›®</button>
        </div>
    </div></div>
</div>

<div class="modal fade" id="intervalModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered"><div class="modal-content" style="border-radius: 20px;">
        <div class="modal-body p-4 text-center">
            <h5 id="intItemName" class="fw-bold mb-3">ä¿®æ”¹é€±æœŸ</h5>
            <div class="input-group mb-3">
                <input type="number" id="newIntervalVal" class="form-control form-control-lg text-center">
                <span class="input-group-text">km</span>
            </div>
            <div class="d-flex gap-2">
                <button class="btn btn-light w-100" data-bs-dismiss="modal">å–æ¶ˆ</button>
                <button onclick="submitNewInterval()" class="btn btn-dark w-100">å„²å­˜</button>
            </div>
        </div>
    </div></div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    // âš ï¸ è«‹ä¿®æ”¹æ­¤è™•ç‚ºä½ çš„ GAS ç¶²å€
    const API_URL = "https://script.google.com/macros/s/AKfycbxNLVPzELXmUeXSmHIoxrKMxsrbtXD7VEWbNMBpahecHjgwm6VHxxNmZlVPb-Ny4EwhIQ/exec"; 
    
    let currentOwnerId = new URLSearchParams(window.location.search).get('id');
    let allItems = [];
    let itemToEdit = "";

    window.onload = () => { 
        if (!currentOwnerId) { 
            hideLoader(); 
            document.getElementById('setup-view').style.display='block'; 
        } else { 
            loadVehicleData(); 
        } 
    };

    function showLoader() { document.getElementById('loader').style.display='flex'; }
    function hideLoader() { document.getElementById('loader').style.display='none'; }

    async function loadVehicleData() {
        showLoader();
        try {
            const res = await fetch(`${API_URL}?ownerId=${currentOwnerId}`);
            const data = await res.json();
            if(data.error) {
                alert("æŸ¥ç„¡è»Šè¼›ï¼Œè«‹é‡æ–°å»ºç«‹");
                window.location.search = "";
                return;
            }
            allItems = data.items;
            document.getElementById('display-name').innerText = data.vehicleName;
            document.getElementById('display-odo').innerText = data.currentOdo + " km";
            
            const container = document.getElementById('items-container');
            container.innerHTML = "";
            
            const cats = ["è€—ææ›´æ›é¡", "ç³»çµ±æª¢æ¸¬é¡"];
            cats.forEach(cat => {
                const items = data.items.filter(i => i.category === cat);
                if (items.length > 0) {
                    container.innerHTML += `<div class="category-header">${cat}</div>`;
                    items.forEach(item => {
                        const statusClass = item.status === "Expired" ? "status-danger" : (item.status === "Warning" ? "status-warn" : "status-ok");
                        const barColor = item.status === "Expired" ? "bg-danger" : (item.status === "Warning" ? "bg-warning" : "bg-success");
                        
                        container.innerHTML += `
                            <div class="card p-3">
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <div onclick="openServiceModal('${item.name}')" style="cursor:pointer">
                                        <b class="fs-5">${item.name}</b>
                                        <div class="small text-muted">é–“éš”: ${item.intervalKm} km</div>
                                    </div>
                                    <div class="text-end">
                                        <div class="${statusClass} mb-1">${item.remKm} km å¾Œ</div>
                                        <span class="edit-icon" onclick="openIntervalModal('${item.name}', ${item.intervalKm})">âš™ï¸ ä¿®æ”¹é€±æœŸ</span>
                                    </div>
                                </div>
                                <div class="progress" onclick="openServiceModal('${item.name}')">
                                    <div class="progress-bar ${barColor}" style="width:${item.progress}%"></div>
                                </div>
                            </div>`;
                    });
                }
            });
            document.getElementById('main-view').style.display='block';
        } catch (e) { alert("é€£ç·šå¤±æ•—ï¼Œè«‹æª¢æŸ¥ API è¨­å®š"); }
        hideLoader();
    }

    async function createNewVehicle() {
        const name = document.getElementById('new-v-name').value;
        const odo = document.getElementById('new-v-odo').value;
        if(!name || !odo) return alert("è«‹è¼¸å…¥è»Šåèˆ‡é‡Œç¨‹");
        showLoader();
        const id = 'BIKE-' + Math.random().toString(36).substr(2,6).toUpperCase();
        await fetch(API_URL, {method:"POST", body:JSON.stringify({action:"createVehicle", ownerId:id, name, odo:parseInt(odo), model:"DEFAULT"})});
        window.location.search = `?id=${id}`;
    }

    function toggleOdoInput() { 
        const el = document.getElementById('update-odo-section'); 
        el.style.display = el.style.display==='none'?'block':'none'; 
    }

    async function submitOdo() {
        const odo = document.getElementById('new-odo-input').value;
        if(!odo) return;
        showLoader();
        await fetch(API_URL, {method:"POST", body:JSON.stringify({action:"updateOdo", ownerId:currentOwnerId, odo:parseInt(odo)})});
        location.reload();
    }

    function openServiceModal(selectedName) {
        const listCont = document.getElementById('multi-select-list');
        listCont.innerHTML = "";
        allItems.forEach(item => {
            const isChecked = item.name === selectedName ? "checked" : "";
            listCont.innerHTML += `
                <div class="form-check p-2 border-bottom">
                    <input class="form-check-input ms-0 me-2" type="checkbox" value="${item.name}" id="chk-${item.name}" ${isChecked}>
                    <label class="form-check-label d-block" for="chk-${item.name}">
                        ${item.name} <span class="small text-muted">(å‰© ${item.remKm} km)</span>
                    </label>
                </div>`;
        });
        document.getElementById('sDate').value = new Date().toISOString().split('T')[0];
        document.getElementById('sOdo').value = document.getElementById('display-odo').innerText.split(' ')[0];
        new bootstrap.Modal(document.getElementById('serviceModal')).show();
    }

    async function submitMultiService() {
        const checkboxes = document.querySelectorAll('#multi-select-list input:checked');
        const selectedNames = Array.from(checkboxes).map(cb => cb.value);
        if (selectedNames.length === 0) return alert("è«‹å‹¾é¸ä¿é¤Šé …ç›®");

        showLoader();
        await fetch(API_URL, {
            method: "POST",
            body: JSON.stringify({
                action: "logService",
                ownerId: currentOwnerId,
                itemNames: selectedNames,
                date: document.getElementById('sDate').value,
                odo: parseInt(document.getElementById('sOdo').value)
            })
        });
        location.reload();
    }

    function openIntervalModal(name, currentVal) {
        itemToEdit = name;
        document.getElementById('intItemName').innerText = `ä¿®æ”¹ ${name} é€±æœŸ`;
        document.getElementById('newIntervalVal').value = currentVal;
        new bootstrap.Modal(document.getElementById('intervalModal')).show();
    }

    async function submitNewInterval() {
        const newVal = document.getElementById('newIntervalVal').value;
        showLoader();
        await fetch(API_URL, {
            method: "POST",
            body: JSON.stringify({
                action: "updateInterval",
                ownerId: currentOwnerId,
                itemName: itemToEdit,
                newInterval: parseInt(newVal)
            })
        });
        location.reload();
    }
</script>
</body>
</html>
